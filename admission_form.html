<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Form | JDVM Lambhua</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #8B0000; --accent: #FF3E3E; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .form-container { max-width: 850px; margin: auto; background: var(--card); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 8px solid var(--primary); }
        
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 28px; font-weight: 800; }
        .header p { margin: 5px 0; opacity: 0.8; font-weight: 600; }

        .section-title { background: #f1f5f9; padding: 10px 15px; border-radius: 8px; margin: 25px 0 15px 0; font-weight: 700; color: var(--primary); display: flex; align-items: center; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 700; color: #475569; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #cbd5e1; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; background: #fffcfc; }

        .fee-info { background: #fff1f1; border: 1px dashed var(--primary); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; }
        
        .submit-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 20px; }
        .submit-btn:hover { background: var(--accent); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(139, 0, 0, 0.3); }

        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; color: white; text-align: center; }
        .file-preview { font-size: 11px; color: #64748b; margin-top: 5px; }
    </style>
</head>
<body>

<div id="overlay">
    <div>
        <h2>✅ Submission Successful!</h2>
        <p>Your Admission Form PDF is downloading...</p>
        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">Fill Another Form</button>
    </div>
</div>

<div class="form-container">
    <div class="header">
        <h1>JANTRAJI DEVI VIDYA MANDIR</h1>
        <p>LAMBHUA, SULTANPUR, UTTAR PRADESH</p>
        <small>Registration for Academic Session 2026-27</small>
    </div>

    <form id="admissionForm">
        <div class="section-title">1. Student Details</div>
        <div class="grid">
            <div>
                <label>Full Name of Applicant*</label>
                <input type="text" id="name" required placeholder="Enter full name">
            </div>
            <div>
                <label>Date of Birth*</label>
                <input type="date" id="dob" required>
            </div>
            <div>
                <label>Gender*</label>
                <select id="gender" required>
                    <option value="">Select Gender</option>
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                </select>
            </div>
            <div>
                <label>Class for Admission*</label>
                <select id="class" required>
                    <option value="">Select Class</option>
                    <option>PG</option><option>LKG</option><option>UKG</option><option>Class-1st</option><option>Class-2nd</option><option>Class-3rd</option>
                    <option>Class-4rth</option><option>Class-5th</option><option>Class-6th</option><option>Class-7th</option>
                    <option>Class-8th</option>
                </select>
            </div>
        </div>

        <div class="section-title">2. Parent / Guardian Details</div>
        <div class="grid">
            <div>
                <label>Father's Name*</label>
                <input type="text" id="father" required>
            </div>
            <div>
                <label>Mother's Name*</label>
                <input type="text" id="mother" required>
            </div>
            <div>
                <label>Contact Mobile Number*</label>
                <input type="tel" id="mobile" pattern="[0-9]{10}" required placeholder="10 Digit Number">
            </div>
            <div>
                <label>WhatsApp Number</label>
                <input type="tel" id="whatsapp">
            </div>
        </div>

        <div class="section-title">3. Address & Additional Info</div>
        <label>Full Residential Address*</label>
        <textarea id="address" rows="3" required placeholder="Village/Post, City, District, PIN"></textarea>
        
        <div class="grid" style="margin-top:15px">
            <div>
                <label>Category</label>
                <select id="category">
                    <option>General</option><option>OBC</option><option>SC/ST</option>
                </select>
            </div>
            <div>
                <label>Aadhar Number (Optional)</label>
                <input type="text" id="aadhar" placeholder="12 Digit Aadhar">
            </div>
        </div>

        <div class="section-title">4. Document Upload</div>
        <div class="grid">
            <div>
                <label>Student Photo* (Passport Size)</label>
                <input type="file" id="photoInput" accept="image/*" required>
                <div class="file-preview">Max size: 500KB (JPG/PNG)</div>
            </div>
            <div>
                <label>Aadhar Card Front* (Image)</label>
                <input type="file" id="aadharInput" accept="image/*" required>
                <div class="file-preview">Max size: 1MB (JPG/PNG)</div>
            </div>
        </div>

        <div class="fee-info">
            <b style="color:var(--primary)">Note:</b> Registration Fee of <b>₹100</b> is applicable. 
            <br><small>(For now, payment is deferred. You can submit the form directly.)</small>
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">PROCEED & SUBMIT FORM</button>
    </form>
</div>

<script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyClB9tZ1ClSyTa27rqDy-TtXSXFKOygy4k",
        authDomain: "academix-d221e.firebaseapp.com",
        projectId: "academix-d221e",
        storageBucket: "academix-d221e.firebasestorage.app",
        messagingSenderId: "285941718942",
        appId: "1:285941718942:web:57b3bbd7773c02a511808f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const form = document.getElementById('admissionForm');

    // Helper to convert Image to Base64
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Processing...";
        btn.disabled = true;

        try {
            const photoFile = document.getElementById('photoInput').files[0];
            const aadharFile = document.getElementById('aadharInput').files[0];

            // Convert images to Base64 to save/display
            const photoBase64 = await toBase64(photoFile);
            const aadharBase64 = await toBase64(aadharFile);

            const formData = {
                name: document.getElementById('name').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                class: document.getElementById('class').value,
                father: document.getElementById('father').value,
                mother: document.getElementById('mother').value,
                mobile: document.getElementById('mobile').value,
                whatsapp: document.getElementById('whatsapp').value,
                address: document.getElementById('address').value,
                category: document.getElementById('category').value,
                aadhar: document.getElementById('aadhar').value,
                submittedAt: new Date().toLocaleString(),
                status: "NEW",
                photo: photoBase64, // Storing image string in Firestore (Note: Only for small images)
                aadharImage: aadharBase64
            };

            // 1. Save to Firebase
            await db.collection("new_requests").add(formData);

            // 2. Generate PDF
            generatePDF(formData);

            // 3. Success
            document.getElementById('overlay').style.display = 'flex';
            
        } catch (error) {
            alert("Error: " + error.message);
            btn.innerText = "PROCEED & SUBMIT FORM";
            btn.disabled = false;
        }
    });

    function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // --- PDF Header ---
        doc.setFillColor(139, 0, 0); 
        doc.rect(0, 0, 210, 40, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("JANTRAJI DEVI VIDYA MANDIR", 105, 18, { align: "center" });
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("LAMBHUA, SULTANPUR, UTTAR PRADESH", 105, 26, { align: "center" });
        doc.text("Academic Session 2026-27 | Admission Registration Slip", 105, 32, { align: "center" });

        // --- Student Photo Slot ---
        if (data.photo) {
            doc.setDrawColor(139, 0, 0);
            doc.setLineWidth(0.5);
            doc.rect(160, 45, 35, 45); // X, Y, Width, Height
            doc.addImage(data.photo, 'JPEG', 161, 46, 33, 43);
        }

        // --- Title ---
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont("helvetica", "bold");
        doc.text("REGISTRATION DETAILS", 20, 55);
        
        // --- Table for Details ---
        const tableBody = [
            ["Applicant Name", data.name.toUpperCase()],
            ["Date of Birth", data.dob],
            ["Gender", data.gender],
            ["Class Applied", data.class],
            ["Father's Name", data.father],
            ["Mother's Name", data.mother],
            ["Mobile Number", data.mobile],
            ["Address", data.address],
            ["Category", data.category],
            ["Aadhar Number", data.aadhar || "N/A"]
        ];

        doc.autoTable({
            startY: 60,
            margin: { left: 20, right: 60 }, // Leave space for photo
            body: tableBody,
            theme: 'striped',
            headStyles: { fillColor: [139, 0, 0] },
            styles: { fontSize: 10, cellPadding: 4 },
            columnStyles: { 0: { fontStyle: 'bold', width: 40 } }
        });

        // --- Footer & Signatures ---
        const finalY = doc.lastAutoTable.finalY + 25;
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "italic");
        doc.text("Registration Date: " + data.submittedAt, 20, finalY - 10);
        
        doc.setFont("helvetica", "bold");
        doc.line(20, finalY + 15, 70, finalY + 15);
        doc.text("Parent Signature", 20, finalY + 20);
        
        doc.line(140, finalY + 15, 190, finalY + 15);
        doc.text("Office Seal/Principal", 140, finalY + 20);

        doc.setFontSize(8);
        doc.setFont("helvetica", "normal");
        doc.setTextColor(100);
        doc.text("Note: Please bring a printout of this slip and original Aadhar for verification.", 105, finalY + 35, { align: "center" });

        // Save PDF
        doc.save(`${data.name}_JDVM_Form.pdf`);
    }
</script>

</body>
</html>
