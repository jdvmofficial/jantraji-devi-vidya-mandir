<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Form | JDVM Lambhua</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #8B0000; --accent: #FF3E3E; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .form-container { max-width: 850px; margin: auto; background: var(--card); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 8px solid var(--primary); }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 28px; font-weight: 800; }
        .section-title { background: #f1f5f9; padding: 10px 15px; border-radius: 8px; margin: 25px 0 15px 0; font-weight: 700; color: var(--primary); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 700; color: #475569; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #cbd5e1; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; margin-top: 20px; }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; color: white; text-align: center; }
    </style>
</head>
<body>

<div id="overlay">
    <div>
        <h2>âœ… Submission Successful!</h2>
        <p>Your Admission Form PDF is downloading...</p>
        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px;">Fill Another Form</button>
    </div>
</div>

<div class="form-container">
    <div class="header">
        <h1>JANTRAJI DEVI VIDYA MANDIR</h1>
        <p>LAMBHUA, SULTANPUR, UTTAR PRADESH</p>
        <small>Registration for Academic Session 2026-27</small>
    </div>

    <form id="admissionForm">
        <div class="section-title">1. Student Details</div>
        <div class="grid">
            <div><label>Full Name*</label><input type="text" id="name" required></div>
            <div><label>Date of Birth*</label><input type="date" id="dob" required></div>
            <div><label>Gender*</label><select id="gender" required><option value="">Select</option><option>Male</option><option>Female</option></select></div>
            <div><label>Class*</label><select id="class" required><option value="">Select</option><option>PG</option><option>LKG</option><option>UKG</option><option>Class-1st</option><option>Class-2nd</option><option>Class-3rd</option></select></div>
        </div>

        <div class="section-title">2. Parent Details</div>
        <div class="grid">
            <div><label>Father's Name*</label><input type="text" id="father" required></div>
            <div><label>Mother's Name*</label><input type="text" id="mother" required></div>
            <div><label>Mobile Number*</label><input type="tel" id="mobile" pattern="[0-9]{10}" required></div>
            <div><label>Aadhar Number</label><input type="text" id="aadhar"></div>
        </div>

        <div class="section-title">3. Documents (Photos)</div>
        <div class="grid">
            <div><label>Student Photo*</label><input type="file" id="photoInput" accept="image/*" required></div>
            <div><label>Aadhar Front Image*</label><input type="file" id="aadharInput" accept="image/*" required></div>
        </div>

        <div class="section-title">4. Address</div>
        <textarea id="address" rows="3" required placeholder="Full Address"></textarea>

        <button type="submit" class="submit-btn" id="submitBtn">SUBMIT & DOWNLOAD PDF</button>
    </form>
</div>

<script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyClB9tZ1ClSyTa27rqDy-TtXSXFKOygy4k",
        authDomain: "academix-d221e.firebaseapp.com",
        projectId: "academix-d221e",
        storageBucket: "academix-d221e.firebasestorage.app",
        messagingSenderId: "285941718942",
        appId: "1:285941718942:web:57b3bbd7773c02a511808f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Image Compression Function ---
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 400; // Size chota kar diya
                    const scaleSize = MAX_WIDTH / img.width;
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // 70% Quality
                };
            };
        });
    }

    document.getElementById('admissionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Compressing & Saving...";
        btn.disabled = true;

        try {
            // Compress both images
            const photoFile = document.getElementById('photoInput').files[0];
            const aadharFile = document.getElementById('aadharInput').files[0];
            
            const compressedPhoto = await compressImage(photoFile);
            const compressedAadhar = await compressAadhar(aadharFile); // Alag function for aadhar quality

            const formData = {
                name: document.getElementById('name').value,
                dob: document.getElementById('dob').value,
                class: document.getElementById('class').value,
                father: document.getElementById('father').value,
                mother: document.getElementById('mother').value,
                mobile: document.getElementById('mobile').value,
                address: document.getElementById('address').value,
                aadhar: document.getElementById('aadhar').value,
                photo: compressedPhoto,  // Compressed string
                submittedAt: new Date().toLocaleString()
            };

            // Save to Firestore (Now it fits in 1MB!)
            await db.collection("new_requests").add(formData);

            generatePDF(formData);
            document.getElementById('overlay').style.display = 'flex';

        } catch (error) {
            alert("Error: " + error.message);
            btn.disabled = false;
            btn.innerText = "SUBMIT & DOWNLOAD PDF";
        }
    });

    async function compressAadhar(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => resolve(e.target.result); // Aadhar ko normal Base64 rakh rahe hain
        });
    }

    function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header
        doc.setFillColor(139, 0, 0);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(20);
        doc.text("JANTRAJI DEVI VIDYA MANDIR", 105, 20, { align: "center" });

        // Photo
        if (data.photo) {
            doc.rect(160, 45, 35, 45);
            doc.addImage(data.photo, 'JPEG', 161, 46, 33, 43);
        }

        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.text("ADMISSION SLIP 2026-27", 20, 50);

        const body = [
            ["Name", data.name],
            ["DOB", data.dob],
            ["Class", data.class],
            ["Father", data.father],
            ["Mobile", data.mobile],
            ["Address", data.address]
        ];

        doc.autoTable({
            startY: 60,
            margin: { right: 60 },
            body: body,
            theme: 'grid',
            headStyles: { fillColor: [139, 0, 0] }
        });

        doc.save(`${data.name}_Admission.pdf`);
    }
</script>
</body>
</html>
