<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Form | JDVM Lambhua</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #8B0000; --accent: #FF3E3E; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .form-container { max-width: 850px; margin: auto; background: var(--card); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-top: 8px solid var(--primary); }
        
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        .header h1 { margin: 0; color: var(--primary); font-size: 28px; font-weight: 800; }
        .header p { margin: 5px 0; opacity: 0.8; font-weight: 600; }

        .section-title { background: #f1f5f9; padding: 10px 15px; border-radius: 8px; margin: 25px 0 15px 0; font-weight: 700; color: var(--primary); display: flex; align-items: center; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }

        label { display: block; margin-bottom: 5px; font-size: 13px; font-weight: 700; color: #475569; }
        input, select, textarea { width: 100%; padding: 12px; border: 1.5px solid #cbd5e1; border-radius: 10px; font-size: 14px; box-sizing: border-box; }
        input:focus { border-color: var(--primary); outline: none; background: #fffcfc; }

        .fee-info { background: #fff1f1; border: 1px dashed var(--primary); padding: 15px; border-radius: 10px; margin: 20px 0; text-align: center; }
        
        .submit-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; transition: 0.3s; margin-top: 20px; }
        .submit-btn:disabled { background: #ccc; cursor: not-allowed; }

        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; justify-content: center; align-items: center; color: white; text-align: center; }
    </style>
</head>
<body>

<div id="overlay">
    <div>
        <h2>✅ Submission Successful!</h2>
        <p>Your Admission Form PDF is downloading...</p>
        <button onclick="location.reload()" style="padding: 10px 20px; margin-top: 20px; cursor: pointer;">Fill Another Form</button>
    </div>
</div>

<div class="form-container">
    <div class="header">
        <h1>JANTRAJI DEVI VIDYA MANDIR</h1>
        <p>LAMBHUA, SULTANPUR, UTTAR PRADESH</p>
        <small>Registration for Academic Session 2026-27</small>
    </div>

    <form id="admissionForm">
        <div class="section-title">1. Student Details</div>
        <div class="grid">
            <div>
                <label>Full Name of Applicant*</label>
                <input type="text" id="name" required placeholder="Enter full name">
            </div>
            <div>
                <label>Date of Birth*</label>
                <input type="date" id="dob" required>
            </div>
            <div>
                <label>Gender*</label>
                <select id="gender" required>
                    <option value="">Select Gender</option>
                    <option>Male</option>
                    <option>Female</option>
                </select>
            </div>
            <div>
                <label>Class for Admission*</label>
                <select id="class" required>
                    <option value="">Select Class</option>
                    <option>PG</option><option>LKG</option><option>UKG</option>
                    <option>Class-1st</option><option>Class-2nd</option><option>Class-3rd</option>
                    <option>Class-4rth</option><option>Class-5th</option><option>Class-6th</option>
                    <option>Class-7th</option><option>Class-8th</option>
                </select>
            </div>
        </div>

        <div class="section-title">2. Parent / Guardian Details</div>
        <div class="grid">
            <div><label>Father's Name*</label><input type="text" id="father" required></div>
            <div><label>Mother's Name*</label><input type="text" id="mother" required></div>
            <div><label>Mobile Number*</label><input type="tel" id="mobile" pattern="[0-9]{10}" required placeholder="10 Digit"></div>
            <div><label>Aadhar Number</label><input type="text" id="aadhar" placeholder="12 Digit Aadhar"></div>
        </div>

        <div class="section-title">3. Document Upload (Photos)</div>
        <div class="grid">
            <div>
                <label>Student Passport Photo*</label>
                <input type="file" id="photoInput" accept="image/*" required>
            </div>
            <div>
                <label>Aadhar Card Front Image*</label>
                <input type="file" id="aadharInput" accept="image/*" required>
            </div>
        </div>

        <div class="section-title">4. Address</div>
        <textarea id="address" rows="3" required placeholder="Village, Post, District, PIN"></textarea>

        <div class="fee-info">
            <b style="color:var(--primary)">Note:</b> Registration Fee of <b>₹100</b> is applicable at school office.
        </div>

        <button type="submit" class="submit-btn" id="submitBtn">PROCEED & SUBMIT FORM</button>
    </form>
</div>

<script>
    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyClB9tZ1ClSyTa27rqDy-TtXSXFKOygy4k",
        authDomain: "academix-d221e.firebaseapp.com",
        projectId: "academix-d221e",
        storageBucket: "academix-d221e.firebasestorage.app",
        messagingSenderId: "285941718942",
        appId: "1:285941718942:web:57b3bbd7773c02a511808f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Image Compression Logic ---
    async function compressImage(file, maxWidth = 400, quality = 0.7) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
            };
        });
    }

    document.getElementById('admissionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.innerText = "Processing... Please wait";
        btn.disabled = true;

        try {
            const photoFile = document.getElementById('photoInput').files[0];
            const aadharFile = document.getElementById('aadharInput').files[0];

            // Compress to stay under 1MB Firestore limit
            const compressedPhoto = await compressImage(photoFile, 300, 0.7); 
            const compressedAadhar = await compressImage(aadharFile, 600, 0.6); // Aadhar wide hota hai

            const formData = {
                name: document.getElementById('name').value,
                dob: document.getElementById('dob').value,
                gender: document.getElementById('gender').value,
                class: document.getElementById('class').value,
                father: document.getElementById('father').value,
                mother: document.getElementById('mother').value,
                mobile: document.getElementById('mobile').value,
                address: document.getElementById('address').value,
                aadharNo: document.getElementById('aadhar').value,
                photo: compressedPhoto,
                aadharImg: compressedAadhar,
                submittedAt: new Date().toLocaleString()
            };

            // 1. Save to Firestore
            await db.collection("new_requests").add(formData);

            // 2. Generate PDF
            generatePDF(formData);

            // 3. Show Success
            document.getElementById('overlay').style.display = 'flex';

        } catch (error) {
            console.error(error);
            alert("Submission Failed: " + error.message);
            btn.disabled = false;
            btn.innerText = "PROCEED & SUBMIT FORM";
        }
    });

    function generatePDF(data) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Header Section
        doc.setFillColor(139, 0, 0);
        doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("JANTRAJI DEVI VIDYA MANDIR", 105, 18, { align: "center" });
        doc.setFontSize(10);
        doc.text("LAMBHUA, SULTANPUR, UTTAR PRADESH", 105, 26, { align: "center" });
        doc.text("Academic Session 2026-27 | Admission Registration Slip", 105, 32, { align: "center" });

        // 1. Student Photo (Top Right)
        if (data.photo) {
            doc.setDrawColor(139, 0, 0);
            doc.rect(160, 45, 35, 45); 
            doc.addImage(data.photo, 'JPEG', 161, 46, 33, 43);
        }

        // 2. Details Table
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.text("STUDENT INFORMATION", 20, 55);
        
        const tableData = [
            ["Applicant Name", data.name.toUpperCase()],
            ["Date of Birth", data.dob],
            ["Gender", data.gender],
            ["Class Applied", data.class],
            ["Father's Name", data.father],
            ["Mother's Name", data.mother],
            ["Mobile Number", data.mobile],
            ["Aadhar Number", data.aadharNo || "N/A"],
            ["Full Address", data.address]
        ];

        doc.autoTable({
            startY: 62,
            margin: { left: 20, right: 60 },
            body: tableData,
            theme: 'striped',
            headStyles: { fillColor: [139, 0, 0] },
            styles: { fontSize: 10, cellPadding: 3 }
        });

        // 3. Aadhar Image Section (Below Table)
        const currentY = doc.lastAutoTable.finalY + 10;
        doc.setFont("helvetica", "bold");
        doc.text("UPLOADED AADHAR PREVIEW:", 20, currentY);
        
        if (data.aadharImg) {
            // Aadhar Card ko thoda bada aur wide dikhane ke liye
            doc.setDrawColor(200);
            doc.rect(20, currentY + 5, 100, 60); // Aadhar Box
            doc.addImage(data.aadharImg, 'JPEG', 21, currentY + 6, 98, 58);
        }

        // 4. Footer & Signatures
        const footerY = currentY + 80;
        doc.setFontSize(10);
        doc.line(20, footerY + 10, 70, footerY + 10);
        doc.text("Parent Signature", 20, footerY + 16);
        
        doc.line(140, footerY + 10, 190, footerY + 10);
        doc.text("Principal / Office", 140, footerY + 16);

        doc.setFontSize(8);
        doc.setTextColor(100);
        doc.text("Generated on: " + data.submittedAt, 105, footerY + 30, { align: "center" });

        // Save
        doc.save(`${data.name}_Admission_Form.pdf`);
    }
</script>

</body>
</html>
